# app/telegram_router.py
import os
import json
import httpx
from typing import Dict, Any
from app.ai import plan_workflow_with_ai, draft_n8n_json_with_ai
from app.n8n_builder import make_minimal_valid_n8n, validate_n8n_json
from app.library_loader import search_library_candidates

TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "")
TELEGRAM_API = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}"
START_MESSAGE = (
    "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹! Ø£Ù†Ø§ Ø¨ÙˆØª Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£ØªÙ…ØªØªØ© Ù„Ù€ n8n.\n\n"
    "## ÙƒÙŠÙ ØªØ³ØªØ¹Ù…Ù„Ù†ÙŠØŸ\n"
    "1) Ø§Ø´Ø±Ø­ Ø·Ù„Ø¨Ùƒ Ø¨ÙˆØ¶ÙˆØ­: *Ø§Ù„Ù‡Ø¯ÙØŒ Ø§Ù„Ù…ØµØ¯Ø±/Ø§Ù„Ø®Ø¯Ù…Ø©ØŒ Ø§Ù„ØªÙƒØ±Ø§Ø±/Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©ØŒ ÙˆØ§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©.*\n"
    "   - Ù…Ø«Ø§Ù„: \"ÙƒÙ„ 3 Ø³Ø§Ø¹Ø§ØªØŒ Ø¬Ø¨Ù„ÙŠ Ø³Ø¹Ø± BTC Ù…Ù† APIØŒ Ø«Ù… Ø£Ø¶Ù ØµÙØ§Ù‹ ÙÙŠ Google Sheet Ø¨Ø§Ø³Ù… 'Prices'\".\n"
    "2) Ø³Ø£Ø·Ø±Ø­ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„ØªØ£ÙƒÙŠØ¯ ÙˆØ¬Ù…Ø¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ØŒ Ø§Ù„Ø­Ù‚ÙˆÙ„ØŒ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øªâ€¦).\n"
    "3) Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŒ Ø³Ø£Ø±Ø³Ù„ Ù„Ùƒ *Ù…Ù„Ù JSON Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙÙŠ n8n Cloud*.\n\n"
    "Ù†ØµØ§Ø¦Ø­ Ù„ÙˆØµÙ Ù…Ù…ØªØ§Ø²:\n"
    "â€¢ Ø­Ø¯Ù‘Ø¯ *Ø§Ù„ØªØ±ÙØºØ±* (Webhook/Cron/Manual) + *Ø§Ù„Ø®Ø·ÙˆØ§Øª* (HTTP, IF, Setâ€¦) + *Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©* (Sheet/DB/API).\n"
    "â€¢ Ø¥Ù† ÙƒØ§Ù† Ø¹Ù†Ø¯Ùƒ Ø­Ø³Ø§Ø¨Ø§Øª/Ù…ÙØ§ØªÙŠØ­ØŒ Ø§Ø°ÙƒØ± Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙ‚Ø·. Ø§Ù„Ù‚ÙÙŠÙÙ… Ø§Ù„Ø­Ø³Ù‘Ø§Ø³Ø© ØªØ¨Ù‚Ù‰ ÙƒÙ€ env Ø¯Ø§Ø®Ù„ n8n.\n\n"
    "Ø§ÙƒØªØ¨: /generate Ù„Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© ØªÙˆÙ„ÙŠØ¯ ÙˆØ±Ù’ÙƒÙÙ„Ùˆ Ø¬Ø¯ÙŠØ¯Ø© âœ¨"
)

async def send_message(chat_id: int, text: str, reply_markup: Dict[str, Any] | None = None):
    async with httpx.AsyncClient(timeout=30) as client:
        payload = {"chat_id": chat_id, "text": text, "parse_mode": "Markdown"}
        if reply_markup:
            payload["reply_markup"] = reply_markup
        await client.post(f"{TELEGRAM_API}/sendMessage", json=payload)

async def send_document(chat_id: int, filename: str, content: bytes):
    async with httpx.AsyncClient(timeout=60) as client:
        files = {"document": (filename, content, "application/json")}
        data = {"chat_id": chat_id}
        await client.post(f"{TELEGRAM_API}/sendDocument", data=data, files=files)

async def handle_update(update: Dict[str, Any]):
    message = update.get("message") or update.get("edited_message")
    if not message:
        return
    chat_id = message["chat"]["id"]
    text = (message.get("text") or "").strip()

    if text in ("/start", "start", "/help"):
        await send_message(chat_id, START_MESSAGE)
        return

    if text.lower().startswith("/generate"):
        await send_message(
            chat_id,
            "ØªÙ…Ø§Ù…! Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ø£ØªÙ…ØªØªØ© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯Ù‡Ø§ Ø¨Ø§Ù„ØªÙØµÙŠÙ„ (Ø§Ù„ØªØ±ØºØ±ØŒ Ø§Ù„Ø®Ø·ÙˆØ§ØªØŒ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª). "
            "Ù…Ø«Ø§Ù„: \"ÙƒÙ„ 3 Ø³Ø§Ø¹Ø§ØªØŒ Ù†Ø§Ø¯Ù API Ø³Ø¹Ø± BTC Ø«Ù… Ø£Ø¶Ù ØµÙØ§Ù‹ ÙÙŠ Google Sheets\"."
        )
        return

    # Ø®Ø·ÙˆØ© 1: ØªÙ„Ø®ÙŠØµ/ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª + Ø§Ù‚ØªØ±Ø§Ø­ Ø¹Ù‚Ø¯/ØªØ±ÙŠØºØ±
    plan = await plan_workflow_with_ai(user_prompt=text)

    # Ø®Ø·ÙˆØ© 2: Ø§Ø³ØªØºÙ„Ø§Ù„ Ù…ÙƒØªØ¨Ø© Ø¬Ø§Ù‡Ø²Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª Ù…Ù†Ø§Ø³Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    library_hits = search_library_candidates(text, top_k=3)
    if library_hits:
        plan += "\n\n# LibraryHints\n" + json.dumps(library_hits, ensure_ascii=False)

    # Ø®Ø·ÙˆØ© 3: ØªÙˆÙ„ÙŠØ¯ n8n JSON Ø¹Ø¨Ø± Ø§Ù„Ù€ AI
    raw_json = await draft_n8n_json_with_ai(plan)

    # Ø®Ø·ÙˆØ© 4: Ø¥Ù†Ù‚Ø§Ø° Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¥Ù„Ù‰ Ù‡ÙŠÙƒÙ„ ØµØ§Ù„Ø­ Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ + ÙØ­Øµ
    try:
        n8n_json = json.loads(raw_json) if isinstance(raw_json, str) else raw_json
    except Exception:
        n8n_json = make_minimal_valid_n8n(
            name="Generated by Bot (Fallback)",
            description="AI failed to return valid JSON; inserted fallback. Plan:\n" + plan
        )

    n8n_json = validate_n8n_json(n8n_json)

    filename = (n8n_json.get("name") or "workflow").replace(" ", "_") + ".json"
    await send_document(chat_id, filename, json.dumps(n8n_json, ensure_ascii=False, indent=2).encode("utf-8"))

    await send_message(
        chat_id,
        "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù n8n JSON Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯. Ø¥Ù† Ø§Ø­ØªØ¬Øª ØªØ¹Ø¯ÙŠÙ„Ø§Øª (Ø¹ÙÙ‚Ø¯ Ø¥Ø¶Ø§ÙÙŠØ©ØŒ Ø´Ø±ÙˆØ·ØŒ Ø­Ù‚ÙˆÙ„)ØŒ Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ³Ø£ÙˆÙ„Ù‘Ø¯ Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ù‘Ø«Ø©."
    )
